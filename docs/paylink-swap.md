> Create helio swap transaction via API

Every transaction in Helio has associated payment request id (prId).
There are 3 different types of payment requests, paylink, stream and invoice.
Each pr can be created in helio dashboard, by logging in.
After which you will have a checkout URL with the prId.
By default, swaps are enabled on newly created paylinks.

This example will focus on paylink swaps, but the same can be applied to other types of payment requests.
Each transaction flow has 5 stages.

- Get currency mappings
- Get swap route for a given pair
- Preparation: user requests transaction object which contains blockchain instructions defined by our smart contract
- Signing all transactions: the user signs the swap and helio transaction with self custody wallet
- Submission: after signing the user submits the transaction to API which in turn will validate and submit the transaction to blockchain with retry and confirm mechanism to make sure the transaction is valid.

### Currencies endpoint

```shell
https://api.hel.io/v1/currency
```

This endpoint returns all the currencies with their mint addresses that Helio supports

### Swap route token

For swaps you need a token generated by helio API, the endpoint:

```shell
https://api.hel.io/v1/swap/route-token
```

Example:

```shell
https://api.hel.io/v1/swap/route-token?paymentRequestId=63974d546a08dc3a09d1c713&paymentRequestType=PAYLINK&fromMint=EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v&amount=10000000
```

In this example we are requesting a swap for 0.1 (10000000) SOL to USDC (mint `EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v`) and the response is a JWT that has the following payload:

```typescript
{
  routeToken: string;
}
```

The content of rate token is:

```JS
{
  "route": "{\"inAmount\":\"243942\",\"outAmount\":\"10000000\",\"priceImpactPct\":0.01010675086136581,\"marketInfos\":[{\"id\":\"DFVTutNYXD8z4T5cRdgpso1G3sZqQvMHWpW2N99E4DvE\",\"label\":\"Orca (Whirlpools)\",\"inputMint\":\"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v\",\"outputMint\":\"So11111111111111111111111111111111111111112\",\"notEnoughLiquidity\":false,\"inAmount\":\"243942\",\"outAmount\":\"10000000\",\"priceImpactPct\":0.010106750861365858,\"lpFee\":{\"amount\":\"2439\",\"mint\":\"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v\",\"pct\":0.01},\"platformFee\":{\"amount\":\"0\",\"mint\":\"So11111111111111111111111111111111111111112\",\"pct\":0}}],\"amount\":\"10000000\",\"slippageBps\":100,\"otherAmountThreshold\":\"246381\",\"swapMode\":\"ExactOut\"}",
  "prid": "63974d546a08dc3a09d1c713",
  "from": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
  "to": "11111111111111111111111111111111",
  "iat": 1674483315,
  "exp": 1674483435
}
```

This token is there to resubmit to the API when calling prepare endpoint. Each token expires after 2 min, after which it is no longer possible to submit the token.

### Paylink swap prepare

Endpoint:

```shell
https://api.hel.io/v1/prepare/transaction/sol/paylink/swap
```

Method:

```shell
[POST]
```

Request payload:

```typescript
export class PrepareSwapTransactionDto {
  "paymentRequestId": "63974d546a08dc3a09d1c713",
  "currency": "SOL",
  "quantity": 1,
  "amount": "10000000",
  "sender": "3Ci626jHVmDpHA**LkNqjQz6Z",
  "mintAddress": "11111111111111111111111111111111",
  "swapRouteToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

This endpoint then returns a payload if everything is valid in the request:

```typescript
export class PrepareTransaction {
  "standardTransaction": {
    "transactionToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "transactionMessage": "{\"type\":\"Buffer\",\"data\":[1,0,2,5,32,183,56,45,124,241,186,60,175,96,168,133,94,218,65,92,193,253,33,72,207,109,127,113,216,208,38,186,169,245,170,62,221,126,245,207,124,124,71,185,94,87,115,112,43,29,86,2,116,178,208,123,128,60,133,246,81,87,97,126,105,64,110,44,255,55,250,89,134,81,24,55,14,59,234,203,189,155,47,186,186,18,26,208,130,100,141,44,117,245,118,162,93,74,7,215,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,198,184,45,190,5,190,51,35,204,139,188,130,98,128,34,172,91,196,108,76,131,79,153,140,155,50,54,43,140,103,158,177,155,115,241,217,145,122,167,116,104,147,145,91,82,147,30,17,57,67,167,129,202,74,0,49,224,93,1,27,242,32,140,222,1,4,5,0,0,1,2,3,28,197,96,243,163,157,0,244,13,128,150,152,0,0,0,0,0,100,0,0,0,0,0,0,0,0,0,0,0]}"
  },
  "swapTransaction": "AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAgSILc4LXzxujyvYKiFXtpBXMH9IUjPbX9x2NAmuqn1qj6Ji+vnsDS1PU9OAuRC9vf6EHDdbDTyYLpSaSrBIm2MDordapbx/fiPiQ7m8px2sudRxMRCWA2yPZuctOrn+J2cn9OEc4NpbtxAdr3BiC6wemEY18inIsUQqa/u4HqPxtqmgMrAzZwOxPsqI1AnvDfHNkvG/QCTX3hPZaDEjuZ9w7YCjwyuAq9wpOBr5nqr7+uWSri+ksY2LM0YFKAunJSHtq4wYviSQltmipXrxr7JXqlTKEEMM/mYho4mt+oGQPDdl+jCJsQQLBuBEH795zdUqtQCS/F+qV53pcpd/dtR4O2YJyAsBgiL2hBKNWkjOVrMrAQL/GDPfHx/dQffKCPv7vqrArddUS+rep1xfiohMZPvRJZAG7oxM7/UPSW2zAsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIX+Ai2CD3ovz2jYlcL8I4Jnp1sCJDTbSH7Q3N3eghcRjJclj04kifG7PRApFI4NgwtaE5na/xCEBI572Nvp+FkDBkZv5SEXMv/srbpyw5vnvIzlu8X3EmssQ5s6QAAAAAR51S3tv2vF7NCdhFNKNK6ll1BDs2/QKyRlC7WEQ1lcBpuIV/6rgYT7aH9jRhjANdrEOdwa6ztVmKDwAAAAAAEG3fbh12Whk9nL4UbO63msHLSF7V9bN5E6jPWFfv8AqQ4DaF+OkJBT5FgSHGb1p2rtx3BqoRyC+KqVKo8reHmp36WcXl39gAVc28uIl0v/iIw9H/6qSTmbpCmRl5/s8WQEDQAFAsBcFQAMBgACAA8KEAAODREQAAUCCAQBBgMHCwkcJzomgGQ+v/mAlpgAAAAAAOa4AwAAAAAAZAAAABADAgAAAQk="
}
```

### Paylink sign transaction

The difference between normal paylink is that you need to sign both transactions, the swap and the standard helio transaction.
In order to sign a transactions we need to reconstruct the transactions.
The standard helio transaction is Solana legacy transaction but the swap transaction is in [Versioned transaction format.](https://docs.solana.com/developing/versioned-transactions)

```typescript
import { Message, Transaction } from '@solana/web3.js';

export function createTransaction(transactionMessage: string): Transaction {
  const message = Message.from(
    Buffer.from(JSON.parse(transactionMessage).data)
  );

  return Transaction.populate(message);
}

export function createSwapTransaction(
  swapTransaction: string
): VersionedTransaction {
  const swapTransactionBuf = Buffer.from(swapTransaction, 'base64');
  return VersionedTransaction.deserialize(swapTransactionBuf);
}
```

After which you can sign the transactions, there are many ways to do it, but if you are in a browser, you can use AnchorWallet, which is the main Solana wallet adapter.

```typescript
// wallet comes from: import { AnchorWallet } from '@solana/wallet-adapter-react';

const [swapSignedTx, signedTx] = await wallet.signAllTransactions([
  swapTx as any,
  standardTx,
]);
return {
  swapSignedTx: swapSignedTx as VersionedTransaction,
  signedTx: JSON.stringify(signedTx.serialize()),
  token: prepareSwapTransactionResponse?.standardTransaction.transactionToken,
};
```

### Paylink submit transaction

After we obtain signed transaction, we have the submit step, which is calling API endpoint:
Endpoint:

```shell
https://api.hel.io/v1/transaction/submit/swap
```

Method:

```shell
[POST]
```

Payload:

```typescript
export class SubmitTransactionDto {
  signedTransaction: string; // signed in the previous step
  paymentRequestId: string; // PR id you get from dash
  quantity: number; // use 1
  currency: string; // you get it from paylink
  transactionToken: string; // you get this from prepare endpoint
}
```

The request should contain the following payload parameters:

After submitting the transaction and if the validity is correct you will get back the following payload:

```typescript
interface Submit {
  content: {
    text: '';
  };
  transactionSignature: '4dfX3g2xEfwNPPXhKB4atuNLWugmrzu1fKHU5KRZ8nFCTHM3VfEgLjboiSAMMBubmJJJBRpRUB54xi94F1Sj7wKr';
  swapTransactionSignature: '2C89pQLLR22469jRp1GCp7DjqQuicPA3RYqc3EeMBYzSqnhkENV5FkPZqgPVkiaP8difyGmzUngnVxPNAedhd3sF';
}
```

You can verify the transaction signature on the blockchain.
